# Cloud Run Environment Variables
# Configure these on each Cloud Run service via:
#   gcloud run services update <service> --region europe-west1 --set-env-vars "KEY=VALUE,..."
#
# Sensitive values (DATABASE_URL, RABBITMQ_URL, JWT_SECRET) should be stored
# in Secret Manager and referenced as secrets, not plain env vars.

# ============================================================
# CI/CD: Database Migration Secret (Cloud Build only)
# ============================================================
# This secret is used ONLY by Cloud Build to run migrations with superuser
# credentials. It is NOT used by any runtime service.
#
# Create the secret:
#   gcloud secrets create medflow-migrate-database-url \
#       --replication-policy="user-managed" --locations="europe-west1"
#
# Set the value (superuser connection string):
#   echo -n "postgres://postgres:<PASSWORD>@db.<REF>.supabase.co:5432/postgres?sslmode=require" \
#       | gcloud secrets versions add medflow-migrate-database-url --data-file=-
#
# Grant Cloud Build access:
#   PROJECT_NUMBER=$(gcloud projects describe $(gcloud config get-value project) --format='value(projectNumber)')
#   gcloud secrets add-iam-policy-binding medflow-migrate-database-url \
#       --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
#       --role="roles/secretmanager.secretAccessor"

# ============================================================
# Common (all services)
# ============================================================

# Server environment - controls validation strictness
MEDFLOW_SERVER_ENVIRONMENT=staging

# Database connection (Supabase PostgreSQL)
# Use Secret Manager: --set-secrets=MEDFLOW_DATABASE_URL=medflow-database-url:latest
MEDFLOW_DATABASE_URL=postgres://medflow_app:<password>@<supabase-host>:5432/postgres?sslmode=require

# Connection pool settings (tune for Cloud Run cold starts)
MEDFLOW_DATABASE_MAX_OPEN_CONNS=10
MEDFLOW_DATABASE_MAX_IDLE_CONNS=2
MEDFLOW_DATABASE_CONN_MAX_LIFETIME=5m

# RabbitMQ (CloudAMQP)
# Use Secret Manager: --set-secrets=MEDFLOW_RABBITMQ_URL=medflow-rabbitmq-url:latest
MEDFLOW_RABBITMQ_URL=amqps://user:pass@host.cloudamqp.com/vhost

# JWT secret (shared across all services)
# Use Secret Manager: --set-secrets=MEDFLOW_JWT_SECRET=medflow-jwt-secret:latest
MEDFLOW_JWT_SECRET=<generate-a-secure-random-string>

# ============================================================
# Per-service: search_path (CRITICAL for multi-tenancy)
# ============================================================

# auth-service
MEDFLOW_DATABASE_SEARCH_PATH=public

# user-service
MEDFLOW_DATABASE_SEARCH_PATH=users, public

# staff-service
MEDFLOW_DATABASE_SEARCH_PATH=staff, public

# inventory-service
MEDFLOW_DATABASE_SEARCH_PATH=inventory, public

# api-gateway (no schema-specific queries)
# MEDFLOW_DATABASE_SEARCH_PATH not needed

# ============================================================
# API Gateway only: backend service URLs
# ============================================================
# Set these to the Cloud Run URLs of backend services.
# Get URLs with: gcloud run services list --region europe-west1 --format="value(status.url)"

MEDFLOW_SERVICES_AUTH_SERVICE_URL=https://medflow-auth-service-xxxxx-ew.a.run.app
MEDFLOW_SERVICES_USER_SERVICE_URL=https://medflow-user-service-xxxxx-ew.a.run.app
MEDFLOW_SERVICES_STAFF_SERVICE_URL=https://medflow-staff-service-xxxxx-ew.a.run.app
MEDFLOW_SERVICES_INVENTORY_SERVICE_URL=https://medflow-inventory-service-xxxxx-ew.a.run.app

# ============================================================
# Staff service only: inter-service URLs
# ============================================================
# These are read via os.Getenv() directly, not via viper config.

USER_SERVICE_URL=https://medflow-user-service-xxxxx-ew.a.run.app
VISION_SERVICE_URL=https://medflow-vision-brain-xxxxx-ew.a.run.app

# ============================================================
# Vision brain only: GPU service URL
# ============================================================
# Set on the vision-brain Cloud Run service, pointing to the GPU service.
# GPU_SERVICE_URL=https://medflow-vision-gpu-xxxxx-ew.a.run.app
