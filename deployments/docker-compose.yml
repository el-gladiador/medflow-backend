services:
  # Message Broker
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: medflow-rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: medflow
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-devpassword}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - medflow-network

  # Single PostgreSQL Database (RLS-based multi-tenancy)
  # All services share this database, isolated by schemas + RLS policies
  # Two DB roles:
  #   medflow     = superuser (migrations only)
  #   medflow_app = non-superuser (services use this, RLS enforced)
  postgres:
    image: postgres:16-alpine
    container_name: medflow-db
    environment:
      POSTGRES_DB: medflow
      POSTGRES_USER: medflow
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/01-init-app-role.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U medflow -d medflow"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - medflow-network

  # Database migrations (runs once, then exits)
  # All app services wait for this to complete before starting.
  migrate:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.migrate
    container_name: medflow-migrate
    environment:
      - DATABASE_URL=postgres://medflow:${DB_PASSWORD:-devpassword}@postgres:5432/medflow?sslmode=disable
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - medflow-network
    restart: "no"

  # Auth Service
  auth-service:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.auth
    container_name: medflow-auth-service
    environment:
      - MEDFLOW_SERVER_PORT=8081
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_DATABASE_HOST=postgres
      - MEDFLOW_DATABASE_PORT=5432
      - MEDFLOW_DATABASE_USER=medflow_app
      - MEDFLOW_DATABASE_PASSWORD=${DB_PASSWORD:-devpassword}
      - MEDFLOW_DATABASE_DATABASE=medflow
      - MEDFLOW_DATABASE_SEARCH_PATH=public
      - MEDFLOW_RABBITMQ_URL=amqp://medflow:${RABBITMQ_PASSWORD:-devpassword}@rabbitmq:5672/
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - MEDFLOW_SERVICES_USER_SERVICE_URL=http://user-service:8082
    ports:
      - "8081:8081"
    depends_on:
      migrate:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    networks:
      - medflow-network
    develop:
      watch:
        - action: rebuild
          path: ../cmd/auth-service
        - action: rebuild
          path: ../internal/auth
        - action: rebuild
          path: ../pkg
        - action: rebuild
          path: ../migrations/supabase
        - action: rebuild
          path: ../go.mod

  # User Service
  user-service:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.user
    container_name: medflow-user-service
    environment:
      - MEDFLOW_SERVER_PORT=8082
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_DATABASE_HOST=postgres
      - MEDFLOW_DATABASE_PORT=5432
      - MEDFLOW_DATABASE_USER=medflow_app
      - MEDFLOW_DATABASE_PASSWORD=${DB_PASSWORD:-devpassword}
      - MEDFLOW_DATABASE_DATABASE=medflow
      - MEDFLOW_DATABASE_SEARCH_PATH=users, public
      - MEDFLOW_RABBITMQ_URL=amqp://medflow:${RABBITMQ_PASSWORD:-devpassword}@rabbitmq:5672/
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
    ports:
      - "8082:8082"
    depends_on:
      migrate:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    networks:
      - medflow-network
    develop:
      watch:
        - action: rebuild
          path: ../cmd/user-service
        - action: rebuild
          path: ../internal/user
        - action: rebuild
          path: ../pkg
        - action: rebuild
          path: ../migrations/supabase
        - action: rebuild
          path: ../go.mod

  # Vision Brain (CPU orchestrator — preprocessing, prompt selection, JSON parsing)
  # No GPU locally — returns 503 for extraction requests (GPU_SERVICE_URL not set)
  vision-brain:
    build:
      context: ../services/vision-brain
      dockerfile: Dockerfile
    container_name: medflow-vision-brain
    environment:
      - PORT=8091
      # GPU_SERVICE_URL intentionally unset — no GPU available in local dev
    ports:
      - "8091:8091"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - medflow-network

  # Staff Service
  staff-service:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.staff
    container_name: medflow-staff-service
    environment:
      - MEDFLOW_SERVER_PORT=8083
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_DATABASE_HOST=postgres
      - MEDFLOW_DATABASE_PORT=5432
      - MEDFLOW_DATABASE_USER=medflow_app
      - MEDFLOW_DATABASE_PASSWORD=${DB_PASSWORD:-devpassword}
      - MEDFLOW_DATABASE_DATABASE=medflow
      - MEDFLOW_DATABASE_SEARCH_PATH=staff, public
      - MEDFLOW_RABBITMQ_URL=amqp://medflow:${RABBITMQ_PASSWORD:-devpassword}@rabbitmq:5672/
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - USER_SERVICE_URL=http://user-service:8082
      - VISION_SERVICE_URL=http://vision-brain:8091
    ports:
      - "8083:8083"
    depends_on:
      migrate:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    networks:
      - medflow-network
    develop:
      watch:
        - action: rebuild
          path: ../cmd/staff-service
        - action: rebuild
          path: ../internal/staff
        - action: rebuild
          path: ../pkg
        - action: rebuild
          path: ../migrations/supabase
        - action: rebuild
          path: ../go.mod

  # Inventory Service
  inventory-service:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.inventory
    container_name: medflow-inventory-service
    environment:
      - MEDFLOW_SERVER_PORT=8084
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_DATABASE_HOST=postgres
      - MEDFLOW_DATABASE_PORT=5432
      - MEDFLOW_DATABASE_USER=medflow_app
      - MEDFLOW_DATABASE_PASSWORD=${DB_PASSWORD:-devpassword}
      - MEDFLOW_DATABASE_DATABASE=medflow
      - MEDFLOW_DATABASE_SEARCH_PATH=inventory, public
      - MEDFLOW_RABBITMQ_URL=amqp://medflow:${RABBITMQ_PASSWORD:-devpassword}@rabbitmq:5672/
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
    ports:
      - "8084:8084"
    depends_on:
      migrate:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    networks:
      - medflow-network
    develop:
      watch:
        - action: rebuild
          path: ../cmd/inventory-service
        - action: rebuild
          path: ../internal/inventory
        - action: rebuild
          path: ../pkg
        - action: rebuild
          path: ../migrations/supabase
        - action: rebuild
          path: ../go.mod

  # API Gateway
  api-gateway:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.gateway
    container_name: medflow-api-gateway
    environment:
      - MEDFLOW_SERVER_PORT=8080
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - MEDFLOW_SERVICES_AUTH_SERVICE_URL=http://auth-service:8081
      - MEDFLOW_SERVICES_USER_SERVICE_URL=http://user-service:8082
      - MEDFLOW_SERVICES_STAFF_SERVICE_URL=http://staff-service:8083
      - MEDFLOW_SERVICES_INVENTORY_SERVICE_URL=http://inventory-service:8084
    ports:
      - "8080:8080"
    depends_on:
      - auth-service
      - user-service
      - staff-service
      - inventory-service
    networks:
      - medflow-network
    develop:
      watch:
        - action: rebuild
          path: ../cmd/api-gateway
        - action: rebuild
          path: ../internal/gateway
        - action: rebuild
          path: ../pkg
        - action: rebuild
          path: ../go.mod

networks:
  medflow-network:
    driver: bridge

volumes:
  rabbitmq-data:
  postgres-data:
