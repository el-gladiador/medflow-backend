services:
  # Message Broker
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: medflow-rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: medflow
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-devpassword}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - medflow-network

  # Auth Database
  postgres-auth:
    image: postgres:16-alpine
    container_name: medflow-db-auth
    environment:
      POSTGRES_DB: medflow_auth
      POSTGRES_USER: medflow
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword}
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U medflow -d medflow_auth"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - medflow-network

  # Users Database
  postgres-users:
    image: postgres:16-alpine
    container_name: medflow-db-users
    environment:
      POSTGRES_DB: medflow_users
      POSTGRES_USER: medflow
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword}
    volumes:
      - postgres-users-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U medflow -d medflow_users"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - medflow-network

  # Staff Database
  postgres-staff:
    image: postgres:16-alpine
    container_name: medflow-db-staff
    environment:
      POSTGRES_DB: medflow_staff
      POSTGRES_USER: medflow
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword}
    volumes:
      - postgres-staff-data:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U medflow -d medflow_staff"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - medflow-network

  # Inventory Database
  postgres-inventory:
    image: postgres:16-alpine
    container_name: medflow-db-inventory
    environment:
      POSTGRES_DB: medflow_inventory
      POSTGRES_USER: medflow
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword}
    volumes:
      - postgres-inventory-data:/var/lib/postgresql/data
    ports:
      - "5436:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U medflow -d medflow_inventory"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - medflow-network

  # Auth Service
  auth-service:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.auth
    container_name: medflow-auth-service
    environment:
      - MEDFLOW_SERVER_PORT=8081
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_DATABASE_HOST=postgres-auth
      - MEDFLOW_DATABASE_PORT=5432
      - MEDFLOW_DATABASE_USER=medflow
      - MEDFLOW_DATABASE_PASSWORD=${DB_PASSWORD:-devpassword}
      - MEDFLOW_DATABASE_DATABASE=medflow_auth
      - MEDFLOW_RABBITMQ_URL=amqp://medflow:${RABBITMQ_PASSWORD:-devpassword}@rabbitmq:5672/
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - MEDFLOW_SERVICES_USER_SERVICE_URL=http://user-service:8082
    ports:
      - "8081:8081"
    depends_on:
      postgres-auth:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - medflow-network

  # User Service
  user-service:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.user
    container_name: medflow-user-service
    environment:
      - MEDFLOW_SERVER_PORT=8082
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_DATABASE_HOST=postgres-users
      - MEDFLOW_DATABASE_PORT=5432
      - MEDFLOW_DATABASE_USER=medflow
      - MEDFLOW_DATABASE_PASSWORD=${DB_PASSWORD:-devpassword}
      - MEDFLOW_DATABASE_DATABASE=medflow_users
      - MEDFLOW_RABBITMQ_URL=amqp://medflow:${RABBITMQ_PASSWORD:-devpassword}@rabbitmq:5672/
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
    ports:
      - "8082:8082"
    depends_on:
      postgres-users:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - medflow-network

  # Staff Service
  staff-service:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.staff
    container_name: medflow-staff-service
    environment:
      - MEDFLOW_SERVER_PORT=8083
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_DATABASE_HOST=postgres-staff
      - MEDFLOW_DATABASE_PORT=5432
      - MEDFLOW_DATABASE_USER=medflow
      - MEDFLOW_DATABASE_PASSWORD=${DB_PASSWORD:-devpassword}
      - MEDFLOW_DATABASE_DATABASE=medflow_staff
      - MEDFLOW_RABBITMQ_URL=amqp://medflow:${RABBITMQ_PASSWORD:-devpassword}@rabbitmq:5672/
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
    ports:
      - "8083:8083"
    depends_on:
      postgres-staff:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - medflow-network

  # Inventory Service
  inventory-service:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.inventory
    container_name: medflow-inventory-service
    environment:
      - MEDFLOW_SERVER_PORT=8084
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_DATABASE_HOST=postgres-inventory
      - MEDFLOW_DATABASE_PORT=5432
      - MEDFLOW_DATABASE_USER=medflow
      - MEDFLOW_DATABASE_PASSWORD=${DB_PASSWORD:-devpassword}
      - MEDFLOW_DATABASE_DATABASE=medflow_inventory
      - MEDFLOW_RABBITMQ_URL=amqp://medflow:${RABBITMQ_PASSWORD:-devpassword}@rabbitmq:5672/
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
    ports:
      - "8084:8084"
    depends_on:
      postgres-inventory:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - medflow-network

  # API Gateway
  api-gateway:
    build:
      context: ..
      dockerfile: deployments/docker/Dockerfile.gateway
    container_name: medflow-api-gateway
    environment:
      - MEDFLOW_SERVER_PORT=8080
      - MEDFLOW_SERVER_ENVIRONMENT=development
      - MEDFLOW_JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - MEDFLOW_SERVICES_AUTH_SERVICE_URL=http://auth-service:8081
      - MEDFLOW_SERVICES_USER_SERVICE_URL=http://user-service:8082
      - MEDFLOW_SERVICES_STAFF_SERVICE_URL=http://staff-service:8083
      - MEDFLOW_SERVICES_INVENTORY_SERVICE_URL=http://inventory-service:8084
    ports:
      - "8080:8080"
    depends_on:
      - auth-service
      - user-service
      - staff-service
      - inventory-service
    networks:
      - medflow-network

networks:
  medflow-network:
    driver: bridge

volumes:
  rabbitmq-data:
  postgres-auth-data:
  postgres-users-data:
  postgres-staff-data:
  postgres-inventory-data:
